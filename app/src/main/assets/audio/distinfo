--------------------------------------------
-- generated with dist/build-distinfo.rua --
--------------------------------------------

name = "audio"
files = {
	"README.md",
	"audio-dev-1.rockspec",
	"audio.lua",
	"buffer.lua",
	"currentsystem.lua",
	"distinfo",
	"ffi/OpenAL.lua",
	"ffi/OpenALUT.lua",
	"ffi/ogg.lua",
	"ffi/vorbiscodec.lua",
	"ffi/vorbisfile.lua",
	"io/ogg.lua",
	"io/wav.lua",
	"null/audio.lua",
	"null/buffer.lua",
	"null/source.lua",
	"openal/audio.lua",
	"openal/buffer.lua",
	"openal/source.lua",
	"sdl_mixer/audio.lua",
	"sdl_mixer/buffer.lua",
	"sdl_mixer/source.lua",
	"source.lua",
	"test/resave.lua",
	"test/test.lua",
}
if ffi.os == "Android" and ffi.arch == "arm" then
	table.append(files, {
		"bin/Android/arm/libogg.so",
		"bin/Android/arm/libopenal.so",
		"bin/Android/arm/libvorbis.so",
		"bin/Android/arm/libvorbisenc.so",
		"bin/Android/arm/libvorbisfile.so",
	})
end
if ffi.os == "Linux" and ffi.arch == "x64" then
	table.append(files, {
		"bin/Linux/x64/libogg.so",
		"bin/Linux/x64/libvorbis.so",
		"bin/Linux/x64/libvorbisenc.so",
		"bin/Linux/x64/libvorbisfile.so",
	})
end
if ffi.os == "OSX" and ffi.arch == "x64" then
	table.append(files, {
		"bin/OSX/x64/libogg.dylib",
		"bin/OSX/x64/libvorbis.dylib",
		"bin/OSX/x64/libvorbisfile.dylib",
	})
end
if ffi.os == "Windows" and ffi.arch == "x64" then
	table.append(files, {
		"bin/Windows/x64/LICENSE.FLAC.txt",
		"bin/Windows/x64/LICENSE.modplug.txt",
		"bin/Windows/x64/LICENSE.mpg123.txt",
		"bin/Windows/x64/LICENSE.ogg-vorbis.txt",
		"bin/Windows/x64/LICENSE.opus.txt",
		"bin/Windows/x64/LICENSE.opusfile.txt",
		"bin/Windows/x64/OpenAL32.dll",
		"bin/Windows/x64/libFLAC-8.dll",
		"bin/Windows/x64/libmodplug-1.dll",
		"bin/Windows/x64/libmpg123-0.dll",
		"bin/Windows/x64/libogg-0.dll",
		"bin/Windows/x64/libopus-0.dll",
		"bin/Windows/x64/libopusfile-0.dll",
		"bin/Windows/x64/libvorbis-0.dll",
		"bin/Windows/x64/libvorbisfile-3.dll",
		"bin/Windows/x64/ogg.dll",
		"bin/Windows/x64/vorbis.dll",
		"bin/Windows/x64/vorbisfile.dll",
	})
end
deps = {
	"ext",
	"ffi",
	--"matrix",	-- just tests
	--"sdl",	-- optional dependency
}

generateBindings = function()return{
	{
		inc = '<ogg/ogg.h>',
		out = 'ogg.lua',
	},

	{
		inc = '<vorbis/codec.h>',
		out = 'vorbiscodec.lua',
	},
	{
		inc = '<vorbis/vorbisfile.h>',
		out = 'vorbisfile.lua',
		includedirs = {
			'/usr/include/vorbis',
			'/usr/local/include/vorbis',
		},
		final = function(code)
			-- the result contains some inline static functions and some static struct initializers which ffi cdef can't handle
			-- ... I need to comment it out *HERE*.
			code = safegsub(code, 'static int _ov_header_fseek_wrap%b()%b{}', '')
			code = safegsub(code, 'static ov_callbacks OV_CALLBACKS_[_%w]+ = %b{};', '')

			code = code .. [[
local lib = require 'ffi.load' 'vorbisfile'

-- don't use stdio, use ffi.C
-- stdio risks browser shimming open and returning a Lua function
-- but what that means is, for browser to work with vorbisfile,
-- browser will have to shim each of he OV_CALLBACKs
-- ... or browser should/will have to return ffi closures of ffi.open
-- ... then we can use stdio here
local stdio = require 'ffi.req' 'c.stdio'	-- fopen, fseek, fclose, ftell

-- i'd free the closure but meh
-- who puts a function as a static in a header anyways?
local _ov_header_fseek_wrap = ffi.cast('int (*)(void *, ogg_int64_t, int)', function(f,off,whence)
	if f == nil then return -1 end
	return stdio.fseek(f,off,whence)
end)

local OV_CALLBACKS_DEFAULT = ffi.new'ov_callbacks'
OV_CALLBACKS_DEFAULT.read_func = stdio.fread
OV_CALLBACKS_DEFAULT.seek_func = _ov_header_fseek_wrap
OV_CALLBACKS_DEFAULT.close_func = stdio.fclose
OV_CALLBACKS_DEFAULT.tell_func = stdio.ftell

local OV_CALLBACKS_NOCLOSE = ffi.new'ov_callbacks'
OV_CALLBACKS_NOCLOSE.read_func = stdio.fread
OV_CALLBACKS_NOCLOSE.seek_func = _ov_header_fseek_wrap
OV_CALLBACKS_NOCLOSE.close_func = nil
OV_CALLBACKS_NOCLOSE.tell_func = stdio.ftell

local OV_CALLBACKS_STREAMONLY = ffi.new'ov_callbacks'
OV_CALLBACKS_STREAMONLY.read_func = stdio.fread
OV_CALLBACKS_STREAMONLY.seek_func = nil
OV_CALLBACKS_STREAMONLY.close_func = stdio.fclose
OV_CALLBACKS_STREAMONLY.tell_func = nil

local OV_CALLBACKS_STREAMONLY_NOCLOSE = ffi.new'ov_callbacks'
OV_CALLBACKS_STREAMONLY_NOCLOSE.read_func = stdio.fread
OV_CALLBACKS_STREAMONLY_NOCLOSE.seek_func = nil
OV_CALLBACKS_STREAMONLY_NOCLOSE.close_func = nil
OV_CALLBACKS_STREAMONLY_NOCLOSE.tell_func = nil

return setmetatable({
	OV_CALLBACKS_DEFAULT = OV_CALLBACKS_DEFAULT,
	OV_CALLBACKS_NOCLOSE = OV_CALLBACKS_NOCLOSE,
	OV_CALLBACKS_STREAMONLY = OV_CALLBACKS_STREAMONLY,
	OV_CALLBACKS_STREAMONLY_NOCLOSE = OV_CALLBACKS_STREAMONLY_NOCLOSE,
}, {
	__index = lib,
})
]]
			return code
		end,
	},

	{
		-- brew install openal-soft
		inc = '<AL/al.h>',
		moreincs = {
			'<AL/alc.h>',
		},
		includedirs = ffi.os == 'OSX' and {
			'/usr/local/opt/openal-soft/include',
		} or nil,
		out = 'OpenAL.lua',
		final = function(code)
			return code .. [[
return require 'ffi.load' 'openal'
]]
		end,
		ffiload = {
			openal = {Windows = 'OpenAL32'},
		},
	},
}end
